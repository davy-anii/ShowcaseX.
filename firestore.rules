rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Users collection - users can read and write their own profile
    match /users/{userId} {
      // Anyone can create a new user document during signup
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow reading for phone number lookups during sign-in (before authentication)
      // This is safe because OTP verification proves phone ownership
      allow read: if true;
      
      // Users can update their own profile
      allow update: if isAuthenticated() && isOwner(userId);
      
      // Users cannot delete their profile (implement via cloud function if needed)
      allow delete: if false;

      // Farming plans (private to the user)
      match /farmingPlans/{planId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }
    
    // Products collection - farmers can create, buyers can read
    match /products/{productId} {
      // Anyone authenticated can read products
      allow read: if isAuthenticated();
      
      // Only farmers can create products
      allow create: if isAuthenticated() && 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'farmer';
      
      // Only the owner can update their product
      allow update: if isAuthenticated() && 
                      resource.data.farmerId == request.auth.uid;
      
      // Only the owner can delete their product
      allow delete: if isAuthenticated() && 
                      resource.data.farmerId == request.auth.uid;
    }
    
    // Contact requests - allow buyers to create, farmers to read their own
    match /contactRequests/{requestId} {
      // Users can read contact requests they're involved in
      allow read: if isAuthenticated() && 
                    (resource.data.buyerId == request.auth.uid || 
                     resource.data.farmerId == request.auth.uid);
      
      // Buyers can create contact requests
      allow create: if isAuthenticated();
      
      // Allow updates for status changes
      allow update: if isAuthenticated() && 
                      (resource.data.buyerId == request.auth.uid || 
                       resource.data.farmerId == request.auth.uid);
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Chats - only participants can read/write
    match /chats/{chatId} {
      function isChatParticipant() {
        // Handle case where document doesn't exist yet (for subscriptions)
        return isAuthenticated() && (
          // If document exists, check if user is a participant
          (resource != null && 
           resource.data.participantIds is list && 
           (request.auth.uid in resource.data.participantIds || 
            request.auth.uid == resource.data.buyerId || 
            request.auth.uid == resource.data.farmerId))
          ||
          // If document doesn't exist, allow read for authenticated users
          // They can only create it if they're a participant (checked in create rule)
          resource == null
        );
      }

      function isChatParticipantOnCreate() {
        return isAuthenticated() && 
               request.resource.data.participantIds is list &&
               (request.auth.uid in request.resource.data.participantIds || 
                request.auth.uid == request.resource.data.buyerId || 
                request.auth.uid == request.resource.data.farmerId);
      }

      allow read: if isChatParticipant();
      allow create: if isChatParticipantOnCreate() && request.resource.data.participantIds.size() == 2;
      allow update: if isAuthenticated() && 
                       resource.data.participantIds is list &&
                       (request.auth.uid in resource.data.participantIds || 
                        request.auth.uid == resource.data.buyerId || 
                        request.auth.uid == resource.data.farmerId);
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        function isMessageParticipant() {
          return isAuthenticated() && 
                 exists(/databases/$(database)/documents/chats/$(chatId)) &&
                 get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds is list &&
                 (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds ||
                  request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.buyerId ||
                  request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.farmerId);
        }
        
        allow read: if isMessageParticipant();
        allow create: if isMessageParticipant() && request.resource.data.senderId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // Hired farmers - buyers can create and read their own, farmers can read when they're the farmer
    match /hiredFarmers/{hiredId} {
      // Buyers can read their own hired farmers
      allow read: if isAuthenticated() && 
                    (resource.data.buyerId == request.auth.uid || 
                     resource.data.farmerId == request.auth.uid);
      
      // Buyers can create hired farmer records
      allow create: if isAuthenticated();
      
      // Allow updates for both parties
      allow update: if isAuthenticated() && 
                      (resource.data.buyerId == request.auth.uid || 
                       resource.data.farmerId == request.auth.uid);
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Market deals - allow buyers and farmers to create and manage their deals
    match /marketDeals/{dealId} {
      // Both buyers and farmers can read deals they're involved in
      allow read: if isAuthenticated() && 
                    (resource.data.buyerId == request.auth.uid || 
                     resource.data.farmerId == request.auth.uid);
      
      // Both buyers and farmers can create market deals
      allow create: if isAuthenticated() && 
                      (request.resource.data.buyerId == request.auth.uid || 
                       request.resource.data.farmerId == request.auth.uid);
      
      // Both parties can update the deal (for status changes, marking as seen, etc.)
      allow update: if isAuthenticated() && 
                      (resource.data.buyerId == request.auth.uid || 
                       resource.data.farmerId == request.auth.uid);
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
